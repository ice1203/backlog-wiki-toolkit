# âš ï¸ é‡è¦: æœ¬ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å‚è€ƒä¾‹ã§ã™
# å®Ÿéš›ã®ä½¿ç”¨å‰ã«ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
# 1. GitHub Secretsã®è¨­å®šï¼ˆBACKLOG_API_KEYï¼‰
# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è¨­å®šå€¤ã®å¤‰æ›´
# 3. ååˆ†ãªãƒ†ã‚¹ãƒˆå®Ÿæ–½
# 4. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å–å¾—

name: Backlog Wiki Sync

# æœ¬ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™
# ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ã—ã€é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„

# on:
#   # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆæ¨å¥¨ï¼‰
#   workflow_dispatch:
#   
#   # ã¾ãŸã¯ã€PRãƒãƒ¼ã‚¸æ™‚ã®è‡ªå‹•å®Ÿè¡Œ
#   # pull_request:
#   #   types: [closed]
#   #   paths:
#   #     - 'wiki/**/*.md'

on: []  # å®Œå…¨ç„¡åŠ¹åŒ–

jobs:
  sync-to-backlog:
    # if: github.event.pull_request.merged == true  # PRãƒãƒ¼ã‚¸æ™‚ã®ã¿å®Ÿè¡Œï¼ˆworkflow_dispatchã§ã¯ä¸è¦ï¼‰
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦PRã®å¤‰æ›´ã‚’æ­£ã—ãæ¤œå‡ºã™ã‚‹ãŸã‚

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Detect changed wiki files
        id: changes
        uses: tj-actions/changed-files@v46
        with:
          files: 'wiki/**/*.md'
          quotepath: false
          safe_output: false

      - name: Extract Wiki information from files
        id: wiki_info
        if: steps.changes.outputs.any_changed == 'true'
        run: |
          echo "Extracting wiki information from changed files..."
          python3 scripts/extract_wiki_info.py ${{ steps.changes.outputs.all_changed_files }}

      - name: Sync to Backlog
        if: steps.changes.outputs.any_changed == 'true'
        env:
          BACKLOG_API_KEY: ${{ secrets.BACKLOG_API_KEY }}
        run: |
          echo "Starting Backlog sync process..."
          
          success_count=0
          error_count=0
          error_details=""
          
          # extract_wiki_info.pyãŒå‡ºåŠ›ã—ãŸwiki_updates.jsonã‚’èª­ã¿å–ã‚Š
          if [ -f "wiki_updates.json" ]; then
            while IFS= read -r line; do
              wiki_id=$(echo "$line" | jq -r '.wiki_id')
              wiki_name=$(echo "$line" | jq -r '.wiki_name')
              file_path=$(echo "$line" | jq -r '.file_path')
              
              if [ "$wiki_id" != "null" ] && [ "$wiki_name" != "null" ]; then
                echo "Updating Wiki ID: $wiki_id, Name: $wiki_name, File: $file_path"
                
                if python3 scripts/backlog_wiki_manager.py update "$wiki_id" "$wiki_name" "$file_path"; then
                  echo "âœ… Successfully updated: $file_path"
                  success_count=$((success_count + 1))
                else
                  echo "âŒ Failed to update: $file_path"
                  error_count=$((error_count + 1))
                  error_details="$error_details\n- $file_path (Wiki ID: $wiki_id)"
                fi
              else
                echo "âš ï¸ Skipping $file_path - Wiki ID or name not found"
                error_count=$((error_count + 1))
                error_details="$error_details\n- $file_path (Wiki ID/åå‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)"
              fi
            done < wiki_updates.json
          else
            echo "âŒ wiki_updates.json not found"
            error_count=1
            error_details="Wikiæƒ…å ±ã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
          
          echo "=== Backlog Sync Results ==="
          echo "Success: $success_count files"
          echo "Errors: $error_count files"
          
          # çµæœã‚’GitHubç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "success_count=$success_count" >> $GITHUB_ENV
          echo "error_count=$error_count" >> $GITHUB_ENV
          echo "error_details<<EOF" >> $GITHUB_ENV
          echo -e "$error_details" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Comment on PR with results
        if: steps.changes.outputs.any_changed == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const successCount = process.env.success_count;
            const errorCount = process.env.error_count;
            const errorDetails = process.env.error_details;
            
            let comment = `## ğŸ”„ Backlog Wiki åŒæœŸçµæœ\n\n`;
            comment += `- âœ… æˆåŠŸ: ${successCount} ãƒ•ã‚¡ã‚¤ãƒ«\n`;
            comment += `- âŒ ã‚¨ãƒ©ãƒ¼: ${errorCount} ãƒ•ã‚¡ã‚¤ãƒ«\n\n`;
            
            if (errorCount > 0) {
              comment += `### ã‚¨ãƒ©ãƒ¼è©³ç´°\n${errorDetails}\n\n`;
              comment += `âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯æ‰‹å‹•ã§Backlogã«åæ˜ ã—ã¦ãã ã•ã„ã€‚\n`;
            } else {
              comment += `ğŸ‰ ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«Backlogã«åæ˜ ã•ã‚Œã¾ã—ãŸï¼\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });